function resizeMainContainer(){$("#main").css("min-height",window.innerHeight+"px"),$("#main .container").css("min-height",window.innerHeight+"px"),$("#overlay").css("width",window.innerWidth),$("#overlay").css("height",window.innerHeight),$(".rlk").css("max-height",window.innerHeight),moveRelLink()}function scrollToMain(){$("html, body").animate({scrollTop:$("#main").offset().top},800)}function moveBackground(){var e=$("body").scrollTop(),n=150*-e/$("#main")[0].offsetTop;0>=n&&$(".bg").css("background-position-y",n+"px")}function moveRelLink(){$(".rlk").css("top","0px"),rlk_upperline=$(".rlk").offset().top,void 0==rlk_upperline?$(".rlk").css("top","0px"):parseInt($(window).scrollTop()-rlk_upperline)+$(".rlk").innerHeight()>$(".toc").innerHeight()?$(".rlk").css("top",$(".toc").innerHeight()-$(".rlk").innerHeight()+"px"):parseInt($(window).scrollTop())>rlk_upperline?$(".rlk").css("top",parseInt($(window).scrollTop()-rlk_upperline)+"px"):$(".rlk").css("top","0px")}function showOverlay(){$("#overlay").show(),$("#overlay").animate({opacity:"1"},1e3)}function hideOverlay(){$("#overlay").animate({opacity:"0"},1e3),setTimeout("$('#overlay').hide();",1e3)}function registerRelLink(e,n){e.click(function(){$("#rel-link").html("");for(var e={},t={},o=0,i=0;i<n.item.length;i++){if(void 0==e[n.item[i].href]){o++,e[n.item[i].href]=$("<li>"),t[n.item[i].href]=0,$("#rel-link").append(e[n.item[i].href]);var a=$("<div>").addClass("collapsible-header truncate rel-link-header orange-text").html(o+". "+n.item[i].title).attr("title",n.item[i].title),r=$("<div>").addClass("collapsible-body rel-link-body");e[n.item[i].href].append(a).append(r)}t[n.item[i].href]++,e[n.item[i].href].children(".collapsible-body").append("("+t[n.item[i].href]+") "+n.item[i].topic+"<br>")}for(var l in e)e[l].children(".collapsible-body").append($("<a>").addClass("right").attr("href",l).attr("target","_new").html('<i class="mdi-action-exit-to-app"></i>Link'));$(".collapsible").collapsible({accordion:!1})})}function send_noun(e){ws.readyState>1?(q_vocab=e,connectWS()):ws.send(JSON.stringify({vocab:e.substring(e.indexOf(" ")),keyword:keyword_now}))}function process(e){if($("#explanation").html(""),$("#rel-link").html(""),$(".hide").removeClass("hide"),$("#main-1").css("min-width","85%"),$("#key").val(e.keyword),$("#key").focus(),$("#time").html("搜尋時間："+e.time+" 秒"),keyword_now=e.keyword,e.noun=e.terms,$("#noun").html(""),void 0!=e.noun)for(var n=0;n<e.noun.length;n++){var t=$("<li>").html(n+1+". "+e.noun[n]);t.addClass("z-depth-1 col s3 blue-text noun-tab truncate waves-effect"),t.click(function(){$(".noun-tab.orange-text").removeClass("orange-text").addClass("blue-text"),$(this).removeClass("blue-text"),$(this).addClass("orange-text"),$("#explanation").html(loading),ws.readyState!=ws.OPEN?(q_vocab=this.innerText,connectWS()):send_noun(this.innerText)}),t.attr("title",e.noun[n]),$("#noun").append(t)}if($("#toc").html(""),void 0!=e.toc)for(var n=0;n<e.toc.length;n++){var t=$("<li>").html(n+1+". "+e.toc[n].topic);t.addClass("col s12 z-depth-1 toc-tab waves-effect"),registerRelLink(t,e.toc[n]),$("#toc").append(t)}}function connectWS(){var e="ws://linux17.csie.ntu.edu.tw:8357/";ws=new WebSocket(e),ws.onopen=function(){console.log("connect to: "+e+" success!"),null!=q_vocab&&(send_noun(q_vocab),q_vocab=null)},ws.onmessage=function(e){var n=JSON.parse(e.data);$("#explanation").html(""),$("#explanation").append($("<h5>").append($("<a>").attr("target","_new").attr("href","https://en.wikipedia.org/wiki/"+n.title).html(n.title))),$("#explanation").append($("<span>").html(n.content)),$("#explanation").append("<br><br>");var t=$("<span>");$("#explanation").append(t);for(var o=0;o<Math.min(n.others.length,4);o++){n.others[o]=decodeURIComponent(decodeURI(decodeURI(n.others[o]))),t.append(0==o?"Others: ":", ");var i=$("<a>");t.append(i),i.attr("href","https://en.wikipedia.org/wiki/"+n.others[o]).attr("target","_new").html(n.others[o])}},ws.onerror=function(){console.log("connection failed."),setTimeout(connectWS,5e3)}}var rlk_upperline,keyword_now,loading=$('<div id="loading"><img src="stylesheets/images/support-loading.gif" height="32px" width="32px"></img></div>'),ws,q_vocab;window.onload=function(){window.addEventListener("resize",resizeMainContainer),window.addEventListener("scroll",moveBackground),window.addEventListener("scroll",moveRelLink),resizeMainContainer(),$("#start-button").click(function(e){e.preventDefault(),scrollToMain()}),$("#good").click(function(e){e.preventDefault(),showOverlay(),$.ajax({url:"/random",type:"GET",dataType:"json",success:function(e){process(e),hideOverlay()},error:function(e,n,t){alert(e.status),alert(t),hideOverlay()}})}),$("#submit").click(function(e){e.preventDefault();var n=$("#key").val();""!=n&&(showOverlay(),$.ajax({url:"/submit",type:"GET",dataType:"json",data:{q:n},success:function(e){process(e),hideOverlay()},error:function(e,n,t){alert(e.status),alert(t),hideOverlay()}}))}),$("#noun-ex-btn").click(function(e){e.preventDefault();var n=$("#noun-ex-key").val();""!=n&&($("#explanation").html(loading),send_noun("1. "+n))}),connectWS()};